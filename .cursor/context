CONTEXT: Proyecto "Sistema de Gestión de Préstamo de Equipos en Laboratorios" (UAA) — Avance / Presentación de Mayo 2025

Resumen del proyecto (lo que ya existe)
- Frontend: Flutter (web + móvil) — la app web está desarrollada; la app móvil se desarrollará con Flutter y consumirá esta API. Mantener compatibilidad con Flutter (requests REST + Authorization header).
- Dashboard web: React.js (se prevé) — backend debe servir endpoints consumibles por dashboard.
- En la presentación se menciona como DB: MongoDB (historial, usuarios, equipos). Mantener MongoDB.

Entidades y campos mínimos (usar exactamente estos nombres en los modelos si aplica)
1) users:
  - _id (ObjectId)
  - email (string, unique)
  - passwordHash (string)
  - firstName (string)
  - lastName (string)
  - role (string enum: 'estudiante'|'profesor'|'admin')
  - active (boolean)
  - createdAt (Date)
  - lastAccess (Date)

2) equipment:
  - _id (ObjectId)
  - code (string, unique)
  - name (string)
  - description (string)
  - category (string)
  - status (enum: 'disponible'|'prestado'|'mantenimiento')
  - location (string)
  - acquisitionDate (Date)
  - estimatedValue (Number)

3) loans:
  - _id (ObjectId)
  - userId (ObjectId -> users)
  - equipmentId (ObjectId -> equipment)
  - reservedAt (Date)
  - startDate (Date)                <-- fecha inicio de préstamo/reserva
  - endDate (Date)                  <-- fecha fin esperada de devolución
  - checkoutAt (Date | null)        <-- cuando se entrega físicamente (admin)
  - returnedAt (Date | null)
  - status (enum: 'reservado'|'activo'|'devuelto'|'vencido')
  - reservationRemarks (string)
  - returnRemarks (string)

4) notifications:
  - _id (ObjectId)
  - userId (ObjectId)
  - type (string: 'reserva'|'recordatorio'|'vencimiento')
  - message (string)
  - read (boolean)
  - sentAt (Date)

Reglas de negocio (firmes):
- Estudiantes: reserva máxima 3 días.
- Profesores: reserva máxima 7 días.
- No permitir solapamiento de reservas/activos para un mismo equipment en el rango [startDate, endDate].
- Cuando un préstamo pasa su endDate y no se devuelve, su status pasa a 'vencido' (cron job o job de comprobación periódica) y se notifica.
- Reservas se crean con status 'reservado'. Un admin realiza checkout para marcar 'activo' (registro de checkoutAt).
- Retornos: cuando se hace return se registra returnedAt y status 'devuelto'; si hay daño, registrar returnRemarks.

Endpoints esperados (debe generarlos):
- Auth:
  - POST /api/auth/login -> { email, password } -> 200 { success:true, data: { token, refreshToken, user } }
  - POST /api/auth/refresh -> { refreshToken } -> 200 { token, refreshToken }
  - POST /api/auth/logout -> { refreshToken } -> 200 { success:true }
  - POST /api/auth/forgot-password -> { email }
  - POST /api/auth/reset-password -> { token, newPassword }

- Users:
  - GET /api/users?page=1&limit=20 (admin)
  - GET /api/users/:id
  - POST /api/users/register -> register new user (initial role 'estudiante' by default)
  - PUT /api/users/:id
  - DELETE /api/users/:id (admin)

- Equipment:
  - GET /api/equipment?page=&limit=&q= (filter by name/category)
  - GET /api/equipment/:id
  - POST /api/equipment (admin)
  - PUT /api/equipment/:id (admin)
  - DELETE /api/equipment/:id (admin)

- Loans:
  - GET /api/loans?page=&limit=&status=&userId=
  - GET /api/loans/:id
  - POST /api/loans/reserve -> { equipmentId, startDate, endDate } (authenticated)
  - PUT /api/loans/:id/checkout -> admin marks checkoutAt and status 'activo'
  - PUT /api/loans/:id/return -> { returnRemarks? } (auth user or admin)
  - GET /api/loans/user/:userId

- Notifications:
  - GET /api/notifications?page=&limit=
  - PUT /api/notifications/:id/read
  - POST /api/notifications/register -> { fcmToken } (store mapping userId->fcmToken)
  - POST /api/notifications/send -> (admin) { userId, type, message }

- Reports (admin):
  - GET /api/reports/usage?from=&to=
  - GET /api/reports/equipment-stats
  - GET /api/reports/user-activity
  - GET /api/reports/overdue

Seguridad y middlewares:
- helmet, express-rate-limit, cors (ALLOWED_ORIGINS desde .env), morgan (dev), express-validator for inputs
- authMiddleware: verificar JWT access token
- roleMiddleware(allowedRoles: string[])
- errorHandler centralizado
- Input/response shape: always `{ success:boolean, data?:any, error?:string }`

Autenticación y tokens:
- ACCESS TOKEN (JWT): expiración por default 2h (configurable desde .env)
- REFRESH TOKEN (JWT): expiración por default 7d (configurable desde .env)
- Guardar refresh tokens en Redis con key `refresh:<userId>:<token>` para revocación en logout/refresh rotation

Notificaciones:
- Integrar **Firebase Admin** para envío push (en dev: simular envío y registrar logs).
- Integrar **nodemailer** para correos (SMTP configurado via .env) — usado en forgot-password y confirmaciones.

Runner / Docker compose (DEBE generarlo así):
- api (construido desde Dockerfile)
- mongo (image: mongo:6) con volumen `mongo-data`
- redis (image: redis:6) con volumen `redis-data`

Provisión de .env.example (incluir exactamente estas variables):
PORT=4000
NODE_ENV=development
JWT_SECRET=changeme_jwt_secret
JWT_ACCESS_EXPIRES=2h
JWT_REFRESH_SECRET=changeme_refresh_secret
JWT_REFRESH_EXPIRES=7d
MONGO_URI=mongodb://root:password@mongo:27017/prestamosdb?authSource=admin
REDIS_HOST=redis
REDIS_PORT=6379
SMTP_HOST=smtp.example.com
SMTP_PORT=465
SMTP_USER=user@example.com
SMTP_PASS=pass
FIREBASE_CREDENTIALS_PATH=/secrets/firebase.json
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8080,http://127.0.0.1:9090

Scripts esperados en package.json:
- dev, build, start, seed, test, lint, wait-for-db

Seeds iniciales (script debe crear):
- Usuarios:
  - admin@uaa.mx / password: AdminPass123! (role: admin)
  - profesor@uaa.mx / password: Profesor123! (role: profesor)
  - estudiante@uaa.mx / password: Estudiante123! (role: estudiante)
- Equipment: al menos 5 equipos (laptops, proyector, microcontrolador)
- Loans: 1 préstamo activo asignado a profesor o estudiante

Tests obligatorios:
- Unit tests: LoanService.createReservation (success, conflict, role limit)
- Integration tests: auth login, equipment list (paginated), reserve flow

Formato de respuestas y errores:
- Código HTTP correcto (401 para no autorizado, 403 para forbidden, 400 para bad request, 409 para conflict en solapamiento)
- Mensajes de error claros para el frontend

Instrucciones para el frontend (ejemplos que el backend debe documentar en README):
- Login:
  - POST /api/auth/login { email, password } -> { success:true, data:{ token, refreshToken, user } }
- Uso del token:
  - Header `Authorization: Bearer <token>`
- Refresh:
  - POST /api/auth/refresh { refreshToken } -> returns new tokens
- Envío de fcmToken (push):
  - POST /api/notifications/register { fcmToken } (auth)

Criterios de entrega:
- Repo funcional con `docker-compose up --build`.
- Tests ejecutan y pasan en CI.
- README te dice exactamente cómo conectar el frontend (headers, endpoints ejemplo curl).
- Swagger con los endpoints y ejemplos.

Fin del contexto.
